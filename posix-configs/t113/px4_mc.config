#!/bin/sh
# PX4 commands need the 'px4-' prefix in bash.
# (px4-alias.sh is expected to be in the PATH)
. px4-alias.sh

param select parameters.bson
param import

param set SENS_BOARD_ROT 0

param set SDLOG_MODE 0

# system_power unavailable
param set-default CBRK_SUPPLY_CHK 894281

# Disable safety switch by default
param set-default CBRK_IO_SAFETY 22027

# broadcast to LAN
# always keep current config
param set SYS_AUTOCONFIG 0
# useless but required for parameter completeness

param set SYS_AUTOSTART 4001
param set MAV_TYPE 2

# param set MPC_LAND_SPEED 0.8
# param set LNDMC_Z_VEL_MAX 0.8

param set EKF2_MULTI_IMU 0
param set SENS_IMU_MODE 0
param set IMU_GYRO_RATEMAX 400

. ${R}etc/init.d/rc.mc_defaults
param set-default CA_ROTOR_COUNT 4
param set-default CA_ROTOR0_PX 0.15
param set-default CA_ROTOR0_PY 0.15
param set-default CA_ROTOR1_PX -0.15
param set-default CA_ROTOR1_PY -0.15
param set-default CA_ROTOR2_PX 0.15
param set-default CA_ROTOR2_PY -0.15
param set-default CA_ROTOR2_KM -0.05
param set-default CA_ROTOR3_PX -0.15
param set-default CA_ROTOR3_PY 0.15
param set-default CA_ROTOR3_KM -0.05

param set PWM_MAIN_DIS1 1000
param set PWM_MAIN_DIS2 1000
param set PWM_MAIN_DIS3 1000
param set PWM_MAIN_DIS4 1000

param set PWM_MAIN_MIN1 1100
param set PWM_MAIN_MIN2 1100
param set PWM_MAIN_MIN3 1100
param set PWM_MAIN_MIN4 1100

param set PWM_MAIN_MAX1 2000
param set PWM_MAIN_MAX2 2000
param set PWM_MAIN_MAX3 2000
param set PWM_MAIN_MAX4 2000

dataman start

load_mon start

battery_status start

bmi088 -A -R 10 -s start
bmi088 -G -R 10 -s start

bmp388 -I -a 0x76 -f 400 start
ist8310 -I -R 12 start

# Optical flow
# pmw3901 -s start
# vl53l1x -X start

rc_input start -d /dev/ttyS5
rc_update start
manual_control start
sensors start
commander start
navigator start
ekf2 start
land_detector start multicopter
mc_hover_thrust_estimator start
flight_mode_manager start
mc_pos_control start
mc_att_control start
mc_rate_control start

mavlink start -x -u 14556 -r 1000000 -p
mavlink stream -u 14556 -s ATTITUDE 		-r 100
mavlink stream -u 14556 -s DISTANCE_SENSOR 	-r 5
mavlink stream -u 14556 -s LOCAL_POSITION_NED 	-r 100
mavlink stream -u 14556 -s OPTICAL_FLOW_RAD	-r 50

# mavlink start -d /dev/ttyS0
linux_pwm_out start
control_allocator start

logger start -t -b 200

mavlink boot_complete
